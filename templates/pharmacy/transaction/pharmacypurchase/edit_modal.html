{% load static %}

<div class="modal-dialog modal-xl" style="max-width: 100%; height: 70vh;">
  <div class="modal-content" style="height: 100%;">
    <div class="modal-body" style="overflow-y: auto;">

      <h4 class="text-center mb-4">Edit Pharmacy Purchase</h4>

      <div class="container-fluid">
        <div class="row">

          <!-- LEFT SIDE -->
          <div class="col-md-6">

            <!-- DATE / STORE / LOCATION -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="fw-semibold">Location</label>
                <input type="text" id="edit_location" class="form-control" placeholder="Enter location">
              </div>

              <div class="col-md-4">
                <label class="fw-semibold">Store <span class="text-danger">*</span></label>
                <input type="hidden" id="edit_tran_id">
                <select id="edit_store" class="form-select">
                  <option value="">Loading...</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="fw-semibold">Date</label>
                <input type="date" id="edit_date" class="form-control">
              </div>
            </div>

            <!-- SUPPLIER / PAYMENT METHOD -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="fw-semibold">Supplier Name</label>
                <input type="text" id="edit_supplier" name="supplier" class="form-control" placeholder="Select Supplier">
              </div>

              <div class="col-md-6">
                <label class="fw-semibold">Payment Method</label>
                <select id="edit_payment_method" name="tran_method" class="form-control">
                  <option value="" disabled selected>Select Payment Method</option>
                  <option value="cash">Cash</option>
                  <option value="bkash">Bkash</option>
                  <option value="nogod">Nogod</option>
                  <option value="rocket">Rocket</option>
                </select>
              </div>
            </div>

            <!-- PRODUCT -->
            <div class="mb-3">
              <label class="fw-semibold">Product Name</label>
              <input type="text" id="edit_productSearch" class="form-control form-control-sm" autocomplete="off">
              <span class="text-danger small name_error"></span>
            </div>

            <!-- QTY / UNIT / EXPIRY / ADD BUTTON -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="fw-semibold">QTY</label>
                <input type="number" id="edit_quantity" name="quantity" class="form-control" required>
              </div>

              <div class="col-md-4">
                <label class="fw-semibold">Unit</label>
                <select id="edit_unit" class="form-select">
                  <option>PCS</option>
                  <option>Box</option>
                  <option>Strip</option>
                  <option>Bottle</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="fw-semibold"></label>
                <button type="button" id="edit_addProductBtn" class="btn btn-success w-100">Add</button>
              </div>

              <div class="col-md-4 mt-2">
                <label class="fw-semibold">Expiry Date</label>
                <input type="date" id="edit_expiry" class="form-control">
              </div>
            </div>

            <!-- CP / MRP / TOTAL -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="fw-semibold">CP</label>
                <input type="number" id="edit_price" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="fw-semibold">MRP</label>
                <input type="number" id="edit_mrp" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="fw-semibold">Total</label>
                <input type="number" id="edit_total" class="form-control" readonly>
              </div>
            </div>

            <!-- SELECTED MEDICINES TABLE -->
            <div class="table-responsive mb-3">
              <table class="table table-bordered table-sm">
                <thead class="bg-success text-white">
                  <tr>
                    <th>SL</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>QTY</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="edit_selectedMedicineList"></tbody>
              </table>
            </div>

          </div>

          <!-- RIGHT SIDE -->
          <div class="col-md-6">

            <!-- PRODUCT LIST -->
            <div class="card mb-4">
              <div class="card-header bg-success text-white text-center">
                Product List
              </div>
              <div class="table-responsive" style="max-height: 280px; overflow-y: auto;">
                <table class="table table-bordered table-sm">
                  <thead class="table-success sticky-top">
                    <tr>
                      <th>SL</th>
                      <th>ID</th>
                      <th>Generic Name</th>
                      <th>Manufacture</th>
                      <th>Form</th>
                      <th>Qty</th>
                      <th>CP</th>
                      <th>MRP</th>
                      <th>Select</th>
                    </tr>
                  </thead>
                  <tbody id="edit_medicineListTableBody"></tbody>
                </table>
              </div>
            </div>

            <!-- INVOICE SUMMARY -->
            <div class="invoice-summary">
              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Invoice Amount</label>
                <div class="col-md-8">
                  <input type="number" id="edit_invoiceAmount" name="bill_amount" class="form-control" readonly>
                </div>
              </div>

              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Discount(%)</label>
                <div class="col-md-8">
                  <input type="number" id="edit_discount" name="discount" class="form-control" value="0">
                </div>
              </div>

              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Net Amount</label>
                <div class="col-md-8">
                  <input type="number" id="edit_netAmount" name="net_amount" class="form-control" readonly>
                </div>
              </div>

              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Advance</label>
                <div class="col-md-8">
                  <input type="number" id="edit_advanced" name="payment" class="form-control">
                </div>
              </div>

              <div class="row g-3 mb-4">
                <label class="col-md-4 fw-semibold">Balance</label>
                <div class="col-md-8">
                  <input type="number" id="edit_balance" name="due" class="form-control" readonly>
                </div>
              </div>

              <div class="text-center">
                <button type="button" id="UpdateBtn" class="btn btn-warning px-5">Update</button>
              </div>

            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>




<script>
  document.getElementById("date").value = new Date().toISOString().substring(0, 10);
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    fetch("/get-stores/")
        .then(response => response.json())
        .then(data => {

            // CREATE FORM STORE
            const storeSelect = document.getElementById("store");
            if(storeSelect){
                storeSelect.innerHTML = '<option value="">Select Store</option>';
                data.stores.forEach(store => {
                    let opt = document.createElement("option");
                    opt.value = store.id;
                    opt.textContent = store.name;
                    if (store.id == 1) opt.selected = true;
                    storeSelect.appendChild(opt);
                });
            }

            // EDIT MODAL STORE
            const editStore = document.getElementById("edit_store");
            if(editStore){
                editStore.innerHTML = '<option value="">Select Store</option>';
                data.stores.forEach(store => {
                    let opt = document.createElement("option");
                    opt.value = store.id;
                    opt.textContent = store.name;
                    editStore.appendChild(opt);
                });
            }

        })
        .catch(error => console.error("Error loading stores:", error));
});
</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/pharmacy/transaction/pharmacy_purchase/product_load.js' %}"></script>
<script src="{% static 'js/pharmacy/transaction/pharmacy_purchase/edit_transaction.js' %}"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script>

$(document).ready(function() {
  // SUBMIT NEW TRANSACTION
    // -------------------------
$(document).off("click", "#SubmitBtn").on("click", "#SubmitBtn", function (e) {
    e.preventDefault();


    let store    = $("#store").val();
    let location = $("#location").val().trim();
    let supplier = $("#supplier").val().trim();
    let method   = $("#payment_method").val();
    let tran_head = $("#tran_id").val();

    let invoice  = parseFloat($("#invoiceAmount").val()) || 0;
    let discount = parseFloat($("#discount").val()) || 0;
    let net      = parseFloat($("#netAmount").val()) || 0;
    let advance  = parseFloat($("#advanced").val()) || 0;
    let balance  = parseFloat($("#balance").val()) || 0;

    let quantity = 0;
    $("#selectedMedicineList tr").each(function () {
        let qty = parseFloat($(this).find("td:eq(3)").text()) || 0;
        quantity += qty;
    });

    // Validation
    if (isNaN(quantity) || quantity <= 0) { alert("Please enter valid quantity"); return; }
    if (!store) { alert("Please select a store."); return; }
    if (!location) { alert("Please enter location."); $("#location").focus(); return; }
    if (!supplier) { alert("Please enter supplier."); $("#supplier").focus(); return; }
    if (!method) { alert("Please select payment method."); return; }
    if (invoice <= 0) { alert("Invoice amount must be greater than 0."); return; }
    if (discount < 0 || discount > 100) { alert("Discount must be between 0–100%"); return; }
    if (net <= 0) { alert("Net amount is invalid."); return; }
    if (advance < 0) { alert("Advance cannot be negative."); return; }
    if (balance < 0) { alert("Balance cannot be negative."); return; }

    // Prepare medicines array
    let medicines = [];
    $("#selectedMedicineList tr").each(function () {
        let pid = $(this).find("td:eq(1)").text(); 
        let pname = $(this).find("td:eq(2)").text();
        let qty = parseFloat($(this).find("td:eq(3)").text()) || 0;
        let price = parseFloat($(this).find("td:eq(4)").text()) || 0;
        let total = parseFloat($(this).find("td:eq(5)").text()) || 0;

        medicines.push({
            tran_head_id: pid, 
            name: pname,   // << remove product_id
            qty: qty,
            cp: price,
            total: total
        });
    });

    const data = {
        store_id: store,
        location: location,
        supplier: supplier,
        tran_type: 1,
        tran_head: tran_head,
        tran_method: method,
        bill_amount: invoice,
        discount: discount,
        net_amount: net,
        payment: advance,
        due: balance,
        quantity: quantity,
        medicines: JSON.stringify(medicines),  // medicines array
        csrfmiddlewaretoken: "{{ csrf_token }}"
    };

    $.ajax({
        url: "/transaction/temp/create/",
        type: "POST",
        data: data,
        success: function(res){
            if(res.success){
                alert("Transaction Created!\nTran ID: " + res.tran_id);
                $('#addMedicineModal').modal('hide');
                setTimeout(() => {
                    window.location.href = "?status=1&page=" + res.last_page;
                }, 800); 
            } else {
                alert(res.message || "Something went wrong!");
            }
        },
        error: function(xhr){
            console.error(xhr.responseText);
            alert("Something went wrong!");
        }
    });
});

    $('#supplier').one('focus', function() { // first click e fetch
        $.ajax({
            url: "{% url 'get_suppliers' %}",
            method: "GET",
            success: function(response) {
                let suppliers = response.suppliers;
                let options = suppliers.map(s => `<option value="${s.name}"></option>`).join('');
                $('#supplier').after(`<datalist id="supplier-list">${options}</datalist>`);
                $('#supplier').attr('list', 'supplier-list');
            },
            error: function() {
                alert('Failed to fetch suppliers');
            }
        });
    });
});
</script>

<script>
$(document).ready(function() {
    $('#location').one('focus', function() {
        $.ajax({
            url: "{% url 'get_divisions' %}",
            method: "GET",
            success: function(response) {
                let divisions = response.divisions;
                let options = divisions.map(d => `<option value="${d.name}"></option>`).join('');
                $('#location').after(`<datalist id="division-list">${options}</datalist>`);
                $('#location').attr('list', 'division-list');
            },
            error: function() {
                alert('Failed to fetch divisions');
            }
        });
    });
});
</script>
<!-- {% comment %} <script>
$(document).ready(function () {

    $("#SubmitBtn").on("click", function (e) {
        e.preventDefault();   // page reload বন্ধ

        let store_id = $("#store").val();
        let location = $("#location").val();
        let tran_head_id = $("#tran_head_id").val();
        let tran_method = $("#payment_method").val(); // Payment method dropdown
        let bill_amount = $("#invoiceAmount").val();
        let discount    = $("#discount").val();
        let net_amount  = $("#netAmount").val();
        let payment     = $("#advanced").val();
        let due         = $("#balance").val();      // Balance = Payment

        

        // Validation
        if (!store_id) {
            alert("Please select a store");
            return;
        }

        if (!location) {
            alert("Please select a location");
            return;
        }

        if (!tran_method) {
            alert("Please select a payment method");
            return;
        }

        // AJAX request
        $.ajax({
            url: "/transaction/temp/create/",
            type: "POST",
            data: {
                store_id: store_id,
                location: location,
                tran_head_id: tran_head_id,
                tran_type: 1,
                tran_method: tran_method,
                bill_amount: bill_amount,
                discount: discount,
                net_amount: net_amount,
                payment: payment,
                due: due,
                
                
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
       
              success: function (res) {
              if(res.success){
                  alert("Transaction Created\nTran ID: " + res.tran_id);
                  $('#addMedicineModal').modal('hide');
                  $('#addMedicineForm')[0].reset();
                  

                  $("#medicineTable tbody").prepend(newRow);

                  
              }
          },
            error: function (xhr) {
                console.error(xhr.responseText);
                alert("Something went wrong while submitting");
            }
        });
    });

});
</script> {% endcomment %} -->

