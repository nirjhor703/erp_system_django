<div class="modal-dialog modal-xl" style="max-width: 100%; height: 70vh;">
  <div class="modal-content" style="height: 100%;">
    <div class="modal-body" style="overflow-y: auto;">
      

      <h4 class="text-center mb-4">Add Pharmacy Purchase</h4>

      <div class="container-fluid">
        <div class="row">

          <!-- LEFT SIDE -->
          <div class="col-md-6">

            <!-- DATE / STORE / LOCATION -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="fw-semibold">Location</label>
                <input type="text" id="location" class="form-control" placeholder="Enter location">
              </div>

              <div class="col-md-4">
                <label class="fw-semibold">Store <span class="text-danger">*</span></label>
                <input type="hidden" id="edit_tran_id">
                <select id="store" class="form-select">
                  <option value="">Loading...</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="fw-semibold">Date</label>
                <input type="date" id="date" class="form-control">
                
              </div>
            </div>

            <!-- SUPPLIER -->
            <!-- SUPPLIER AND PAYMENT METHOD ROW -->
            <div class="row mb-3">
              <!-- Supplier Name -->
              <div class="col-md-6">
                <label class="fw-semibold">Supplier Name</label>
                <input type="text" id="supplier" name="supplier" class="form-control" placeholder="Select Supplier">
              </div>

              <!-- Payment Method -->
              <div class="col-md-6">
                <label class="fw-semibold">Payment Method</label>
                <select id="payment_method" name="tran_method" class="form-control">
                  <option value="" disabled selected>Select Payment Method</option>
                  <option value="bkash" selected>Cash</option>
                  <option value="bkash">Bkash</option>
                  <option value="nogod">Nogod</option>
                  <option value="rocket">Rocket</option>
                </select>
              </div>
            </div>


            <!-- PRODUCT -->
            <div class="mb-3">
              <label class="fw-semibold">Product Name</label>
              <input type="text" id="productSearch" class="form-control form-control-sm" autocomplete="off">
              <span class="text-danger small name_error"></span>
            </div>

            <!-- QTY / UNIT / EXPIRY -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="fw-semibold">QTY</label>
                <input type="number" id="quantity" class="form-control">
              </div>

              <div class="col-md-4">
                <label class="fw-semibold">Unit</label>
                <select id="unit" class="form-select">
                  <option>PCS</option>
                  <option>Box</option>
                  <option>Strip</option>
                  <option>Bottle</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="fw-semibold"></label>
                <button type="button" id="addProductBtn" class="btn btn-success w-100">Add</button>
              </div>

              <div class="col-md-4">
                <label class="fw-semibold">Expiry Date</label>
                <input type="date" id="expiry" class="form-control">
              </div>
            </div>

            <!-- CP / MRP / TOTAL -->
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="fw-semibold">CP</label>
                <input type="number" id="price" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="fw-semibold">MRP</label>
                <input type="number" id="mrp" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="fw-semibold">Total</label>
                <input type="number" id="total" class="form-control" readonly>
              </div>
            </div>

            <!-- SELECTED MEDICINES TABLE -->
            <div class="table-responsive mb-3">
              <table class="table table-bordered table-sm">
                <thead class="bg-success text-white">
                  <tr>
                    <th>SL</th>
                    <th>Name</th>
                    <th>QTY</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="selectedMedicineList"></tbody>
              </table>
            </div>

          </div>

          <!-- RIGHT SIDE -->
          <div class="col-md-6">

            <!-- PRODUCT LIST -->
            <div class="card mb-4">
              <div class="card-header bg-success text-white text-center">
                Product List
              </div>
              <div class="table-responsive" style="max-height: 280px; overflow-y: auto;">
                <table class="table table-bordered table-sm">
                  <thead class="table-success sticky-top">
                    <tr>
                      <th>Name</th>
                      <th>Generic Name</th>
                      <th>Manufacture</th>
                      <th>Form</th>
                      <th>Qty</th>
                      <th>CP</th>
                      <th>MRP</th>
                      <th>Select</th>
                    </tr>
                  </thead>
                  <tbody id="medicineListTableBody"></tbody>
                </table>
              </div>
            </div>

            <!-- INVOICE SUMMARY -->
            <div class="invoice-summary">

              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Invoice Amount</label>
                <div class="col-md-8">
                  <input type="number" id="invoiceAmount" name="bill_amount" class="form-control" readonly>
                </div>
              </div>

              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Discount(%)</label>
                <div class="col-md-8">
                  <input type="number" id="discount" name="discount" class="form-control" value="0">
                </div>
              </div>

              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Net Amount</label>
                <div class="col-md-8">
                  <input type="number" id="netAmount" name="net_amount"class="form-control" readonly>
                </div>
              </div>

              <div class="row g-3 mb-2">
                <label class="col-md-4 fw-semibold">Advance</label>
                <div class="col-md-8">
                  <input type="number" id="advanced" name="payment"class="form-control">
                </div>
              </div>

              <div class="row g-3 mb-4">
                <label class="col-md-4 fw-semibold">Balance</label>
                <div class="col-md-8">
                  <input type="number" id="balance" name="due"class="form-control" readonly>
                </div>
              </div>

              <div class="text-center">
                <button type="submit" id="SubmitBtn" class="btn btn-primary px-5">Submit</button>
              </div>

            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>




<script>
  document.getElementById("date").value = new Date().toISOString().substring(0, 10);
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    fetch("/get-stores/")
        .then(response => response.json())
        .then(data => {

            // CREATE FORM STORE
            const storeSelect = document.getElementById("store");
            if(storeSelect){
                storeSelect.innerHTML = '<option value="">Select Store</option>';
                data.stores.forEach(store => {
                    let opt = document.createElement("option");
                    opt.value = store.id;
                    opt.textContent = store.name;
                    if (store.id == 1) opt.selected = true;
                    storeSelect.appendChild(opt);
                });
            }

            // EDIT MODAL STORE
            const editStore = document.getElementById("edit_store");
            if(editStore){
                editStore.innerHTML = '<option value="">Select Store</option>';
                data.stores.forEach(store => {
                    let opt = document.createElement("option");
                    opt.value = store.id;
                    opt.textContent = store.name;
                    editStore.appendChild(opt);
                });
            }

        })
        .catch(error => console.error("Error loading stores:", error));
});
</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#supplier').one('focus', function() { // first click e fetch
        $.ajax({
            url: "{% url 'get_suppliers' %}",
            method: "GET",
            success: function(response) {
                let suppliers = response.suppliers;
                let options = suppliers.map(s => `<option value="${s.name}"></option>`).join('');
                $('#supplier').after(`<datalist id="supplier-list">${options}</datalist>`);
                $('#supplier').attr('list', 'supplier-list');
            },
            error: function() {
                alert('Failed to fetch suppliers');
            }
        });
    });
});
</script>

<script>
$(document).ready(function() {
    $('#location').one('focus', function() {
        $.ajax({
            url: "{% url 'get_divisions' %}",
            method: "GET",
            success: function(response) {
                let divisions = response.divisions;
                let options = divisions.map(d => `<option value="${d.name}"></option>`).join('');
                $('#location').after(`<datalist id="division-list">${options}</datalist>`);
                $('#location').attr('list', 'division-list');
            },
            error: function() {
                alert('Failed to fetch divisions');
            }
        });
    });
});
</script>
{% comment %} <script>
$(document).ready(function () {

    $("#SubmitBtn").on("click", function (e) {
        e.preventDefault();   // page reload বন্ধ

        let store_id = $("#store").val();
        let location = $("#location").val();
        let tran_method = $("#payment_method").val(); // Payment method dropdown
        let bill_amount = $("#invoiceAmount").val();
        let discount    = $("#discount").val();
        let net_amount  = $("#netAmount").val();
        let payment     = $("#advanced").val();
        let due         = $("#balance").val();      // Balance = Payment

        

        // Validation
        if (!store_id) {
            alert("Please select a store");
            return;
        }

        if (!location) {
            alert("Please select a location");
            return;
        }

        if (!tran_method) {
            alert("Please select a payment method");
            return;
        }

        // AJAX request
        $.ajax({
            url: "/transaction/temp/create/",
            type: "POST",
            data: {
                store_id: store_id,
                location: location,
                tran_type: 1,
                tran_method: tran_method,
                bill_amount: bill_amount,
                discount: discount,
                net_amount: net_amount,
                payment: payment,
                due: due,
                
                
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
       
              success: function (res) {
              if(res.success){
                  alert("Transaction Created\nTran ID: " + res.tran_id);
                  $('#addMedicineModal').modal('hide');
                  $('#addMedicineForm')[0].reset();
                  

                  $("#medicineTable tbody").prepend(newRow);

                  
              }
          },
            error: function (xhr) {
                console.error(xhr.responseText);
                alert("Something went wrong while submitting");
            }
        });
    });

});
</script> {% endcomment %}

{% comment %} <script>
$("#SubmitBtn").on("click", function(e){
    e.preventDefault();

    if($(this).text() == "Verify"){
        let tranId = $("#tran_id").val();

        $.ajax({
            url: "/transaction/temp/verify/",
            type: "POST",
            data: {
                tran_id: tranId,
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            success: function(res){
                if(res.success){
                    // Close modal
                    $("#verifyModal").modal("hide");

                    // Change button in table to disabled Verified
                    $(`button[data-tran-id="${res.id}"]`)
                        .replaceWith('<button class="btn btn-sm btn-success" disabled>Verified</button>');
                }
            }
        });
    } else {
        // normal Add flow
    }
});
</script>
 {% endcomment %}
